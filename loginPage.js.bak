document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing login page...');

    // Get form elements
    const loginForm = document.getElementById('loginForm');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginButton = document.querySelector('button[type="submit"]');

    // Verify elements exist
    if (!loginForm || !usernameInput || !passwordInput || !loginButton) {
        console.error('Required form elements not found');
        return;
    }

    // Initialize Parse
    try {
        Parse.initialize(
            '1ViZN5pbU94AJep2LHr2owBflGOGedwvYliU50g0',
            '7CE7gnknAyyfSZRTWpqvuDvNhLOMsF0DNYk8qvgn'
        );
        Parse.serverURL = 'https://parseapi.back4app.com/';
        console.log('Parse initialized successfully');
    } catch (error) {
        console.error('Parse initialization failed:', error);
        alert('Failed to initialize application. Please refresh the page.');
        return;
    }

    // Handle form submission
    loginForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        console.log('Login form submitted');

        // Disable button and show loading state
        loginButton.disabled = true;
        loginButton.textContent = 'Logging in...';

        try {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                throw new Error('Please enter both username and password');
            }

            console.log('Attempting login for:', username);

            // Attempt login
            const user = await Parse.User.logIn(username, password);
            
            if (!user) {
                throw new Error('Login failed - no user returned');
            }

            console.log('Login successful');
            
            // Store session data
            const sessionData = {
                userId: user.id,
                username: user.get('username'),
                sessionToken: user.getSessionToken(),
                expiresAt: Date.now() + (30 * 60 * 1000) // 30 minutes
            };
            
            localStorage.setItem('currentUser', JSON.stringify(sessionData));
            
            // Redirect to dashboard
            window.location.href = './dashboard.html';

        } catch (error) {
            console.error('Login error:', error);
            alert(error.message || 'Login failed. Please try again.');
            
            // Reset form state
            loginButton.disabled = false;
            loginButton.textContent = 'Login';
            passwordInput.value = '';
        }
    });

    // Enable button on page load
    loginButton.disabled = false;
    console.log('Login page initialized');
});
